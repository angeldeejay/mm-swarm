# Override args
FROM karsten13/magicmirror:latest

WORKDIR /opt/magic_mirror
USER root
ENV DEBIAN_FRONTEND=readline

RUN set -ex; \
    apt-get update -qq || exit 1; \
    apt-get install -y -qq libnss3-tools curl wget ffmpeg iputils-ping > /dev/null 2>&1 || exit 1; \
    curl -h > /dev/null 2>&1 || (echo "curl not installed!"; exit 1); \
    wget -h > /dev/null 2>&1 || (echo "wget not installed!"; exit 1); \
    ffmpeg -h > /dev/null 2>&1 || (echo "ffmpeg not installed!"; exit 1); \
    ARCH= && \
    dpkgArch="$(dpkg --print-architecture)" && \
    case "${dpkgArch##*-}" in\
    amd64) ARCH='amd64';;\
    arm64) ARCH='arm64';;\
    armhf) ARCH='arm';;\
    *) echo "unsupported architecture"; exit 1 ;;\
    esac; \
    MKCERT_URL=$(curl -s https://api.github.com/repos/FiloSottile/mkcert/releases/latest | grep browser_download_url | grep "linux-$ARCH" | cut -d '"' -f 4); \
    wget -O /usr/local/bin/mkcert -q "${MKCERT_URL}"; \
    chmod +x /usr/local/bin/mkcert; \
    mkcert -h > /dev/null 2>&1 || (echo "mkcert not installed!"; exit 1); \
    npm install npm@latest -g;

USER node
COPY --chown=node:node entrypoint-mm.sh .

EXPOSE 8080

ENTRYPOINT ["./entrypoint-mm.sh"]